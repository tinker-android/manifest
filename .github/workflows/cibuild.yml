name: CI

on: [push, pull_request]

jobs:
  build-android-img:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Install dependancies
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-8-jdk python git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc unzip
    - name: Install the repo launcher
      run: |
        mkdir ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
    - name: Download the AOSP
      run: |
        nproc
        mkdir ~/aosp && cd ~/aosp
        PATH=~/bin:$PATH
        repo init -u https://bitbucket.org/q4a/manifest -b dev
        repo sync -j$(nproc)
    - name: Test repos
      run: |
        cd ~/aosp/hardware/rockchip/power
        git remote -v
        git log -1
        cd ~/aosp/hardware/rockchip/audio
        git remote -v
        git log -1
    - name: Build Android
      run: |
        cd ~/aosp
        source build/envsetup.sh
        lunch rk3288-userdebug
        cd ~/aosp/kernel
        make ARCH=arm rockchip_defconfig
        make ARCH=arm rk3288-miniarm.img -j$(nproc)
        cd ~/aosp/u-boot
        make rk3288_secure_defconfig
        make -j$(nproc)
        cd ~/aosp
        make -j$(nproc)
    - name: Build image
      run: |
        cd ~/aosp
        ./mkimage.sh
        cd ~/aosp/RKTools/linux/Linux_Pack_Firmware/rockdev
        ./collectImages.sh && ./mkupdate.sh
